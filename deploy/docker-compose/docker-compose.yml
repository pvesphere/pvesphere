services:
  # API 服务
  api:
    build:
      context: ../..
      dockerfile: deploy/build/Dockerfile
      target: backend
      args:
        APP_NAME: server
        APP_ENV: docker
    image: pvesphere-api:latest
    container_name: pvesphere-api
    ports:
      - "8000:8000"
    volumes:
      - ../../config:/data/app/config:ro
      - pvesphere-storage:/data/app/storage
    environment:
      - APP_ENV=docker
      - APP_NAME=server
    # 先运行数据库迁移，然后启动 API 服务
    command: >
      sh -c "echo 'Running migrations...' && 
             ./migration -conf /data/app/config/docker.yml && 
             echo 'Starting server...' && 
             ./server -conf /data/app/config/docker.yml"
    networks:
      - pvesphere-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 控制器服务
  controller:
    build:
      context: ../..
      dockerfile: deploy/build/Dockerfile
      target: backend
      args:
        APP_NAME: controller
        APP_ENV: docker
    image: pvesphere-controller:latest
    container_name: pvesphere-controller
    volumes:
      - ../../config:/data/app/config:ro
      - pvesphere-storage:/data/app/storage
    environment:
      - APP_ENV=docker
      - APP_NAME=controller
    # 显式指定运行 controller 二进制文件
    command: ["sh", "-c", "echo 'Starting controller...' && ./controller -conf /data/app/config/docker.yml"]
    depends_on:
      api:
        condition: service_healthy
    networks:
      - pvesphere-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "controller"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 前端服务（仅支持本地代码构建）
  frontend:
    build:
      context: ../..
      dockerfile: deploy/build/Dockerfile
      target: frontend
    image: pvesphere-frontend:latest
    container_name: pvesphere-frontend
    ports:
      - "8080:8080"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - pvesphere-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # SQLite 数据库和日志存储（多个服务共享）
  pvesphere-storage:

networks:
  pvesphere-network:
    driver: bridge
