services:
  # API 服务
  api:
    build:
      context: ../..
      dockerfile: deploy/build/Dockerfile
      target: backend
      args:
        APP_RELATIVE_PATH: ./cmd/server
        APP_NAME: server
        APP_ENV: docker
    image: pvesphere-api:latest
    container_name: pvesphere-api
    ports:
      - "8000:8000"
    volumes:
      - ../../config:/data/app/config:ro
      - pvesphere-storage:/data/app/storage
    environment:
      - APP_ENV=docker
    command: >
      sh -c "./migration -conf /data/app/config/docker.yml && ./server -conf /data/app/config/docker.yml"
    networks:
      - pvesphere-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 控制器服务
  controller:
    build:
      context: ../..
      dockerfile: deploy/build/Dockerfile
      target: backend
      args:
        APP_RELATIVE_PATH: ./cmd/controller
        APP_NAME: controller
        APP_ENV: docker
    image: pvesphere-controller:latest
    container_name: pvesphere-controller
    volumes:
      - ../../config:/data/app/config:ro
      - pvesphere-storage:/data/app/storage
    environment:
      - APP_ENV=docker
    command: ["./controller", "-conf", "/data/app/config/docker.yml"]
    depends_on:
      api:
        condition: service_healthy
    networks:
      - pvesphere-network
    restart: unless-stopped

  # 前端服务（仅支持本地代码构建）
  frontend:
    build:
      context: ../..
      dockerfile: deploy/build/Dockerfile
      target: frontend
    image: pvesphere-frontend:latest
    container_name: pvesphere-frontend
    ports:
      - "8080:8080"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - pvesphere-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # SQLite 数据库和日志存储（多个服务共享）
  pvesphere-storage:

networks:
  pvesphere-network:
    driver: bridge
